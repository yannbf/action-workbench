version: 2.1
jobs:
  build:
    docker:
      - image: circleci/node:16.10.0
    steps:
      - checkout
      - run:
          name: Setup
          command: |
            echo "Setup starting..."
            yarn install   
      - run:
          name: Test
          command: |
            echo "Running tests..."
            yarn test
      - run:
          name: Trigger Checkly
          command: |
            echo "Deployment finished."
            # Call Checkly trigger
            curl "https://api.checklyhq.com/check-groups/4/trigger/${CHECKLY_TOKEN}" > ${PWD}/checkly.json
            # Exit with an error status if we find more than 0 "hasFailures: true" in the output
            if [ $(grep -c \'"hasFailures":true\' $PWD/checkly.json) -ne 0 ]; then exit 1; fi